// Onlyou Database Schema
// Indian Telehealth Platform for Stigmatized Health Conditions

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// 7 roles per spec: patient, doctor, admin, lab, phlebotomist, pharmacy, delivery
enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
  LAB           // Diagnostic centre staff
  PHLEBOTOMIST  // Sample collectors
  PHARMACY      // Pharmacy partners
  DELIVERY      // Delivery personnel
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum HealthVertical {
  HAIR_LOSS
  SEXUAL_HEALTH
  PCOS
  WEIGHT_MANAGEMENT
}

enum ConsultationStatus {
  PENDING_ASSESSMENT
  AI_REVIEWED
  DOCTOR_REVIEWING
  APPROVED
  NEEDS_INFO
  REJECTED
}

// Spec: master spec Section 8.3 — Order Status Enum
enum OrderStatus {
  PRESCRIPTION_CREATED
  SENT_TO_PHARMACY
  PHARMACY_PREPARING
  PHARMACY_READY
  PHARMACY_ISSUE
  PICKUP_ARRANGED
  OUT_FOR_DELIVERY
  DELIVERED
  DELIVERY_FAILED
  RESCHEDULED
  RETURNED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

// Spec: master spec Section 7.3 — Lab Order Status Enum
// Main flow: ORDERED → SLOT_BOOKED → PHLEBOTOMIST_ASSIGNED → SAMPLE_COLLECTED →
//            DELIVERED_TO_LAB → SAMPLE_RECEIVED → PROCESSING → RESULTS_READY →
//            DOCTOR_REVIEWED → CLOSED
// Branches: COLLECTION_FAILED, SAMPLE_ISSUE, RESULTS_UPLOADED, CANCELLED, EXPIRED
enum LabOrderStatus {
  ORDERED
  SLOT_BOOKED
  PHLEBOTOMIST_ASSIGNED
  SAMPLE_COLLECTED
  COLLECTION_FAILED
  DELIVERED_TO_LAB
  SAMPLE_RECEIVED
  SAMPLE_ISSUE
  PROCESSING
  RESULTS_READY
  RESULTS_UPLOADED      // Patient self-upload path
  DOCTOR_REVIEWED
  CLOSED
  CANCELLED
  EXPIRED
}

// ============================================
// USER & PROFILES
// ============================================

model User {
  id            String    @id @default(cuid())
  phone         String    @unique // +91XXXXXXXXXX format
  email         String?   @unique
  name          String?
  role          UserRole  @default(PATIENT)
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  patientProfile      PatientProfile?
  doctorProfile       DoctorProfile?
  staffProfile        StaffProfile?
  labProfile          LabProfile?
  phlebotomistProfile PhlebotomistProfile?
  pharmacyProfile     PharmacyProfile?
  refreshTokens       RefreshToken[]
  consultations   Consultation[]    @relation("PatientConsultations")
  doctorReviews   Consultation[]    @relation("DoctorConsultations")
  orders          Order[]
  subscriptions   Subscription[]
  payments        Payment[]
  messages        Message[]
  auditLogs       AuditLog[]
  labOrders       LabOrder[]        @relation("PatientLabOrders")

  @@index([phone])
  @@index([role])
}

model PatientProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  dateOfBirth DateTime?
  gender      Gender?
  height      Float?    // in cm
  weight      Float?    // in kg

  // Address (Indian format)
  addressLine1  String?
  addressLine2  String?
  city          String?
  state         String?
  pincode       String?   // 6-digit Indian postal code

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  intakeResponses IntakeResponse[]
  photos          PatientPhoto[]

  @@index([userId])
}

model DoctorProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  registrationNo    String   @unique // Medical Council Registration
  specialization    String
  qualifications    String[]
  yearsOfExperience Int
  bio               String?
  avatarUrl         String?
  isAvailable       Boolean  @default(true)
  consultationFee   Int      @default(0) // in paise

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([specialization])
}

model StaffProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  department String
  employeeId String  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Spec: master spec Section 13 — Partner profiles
model LabProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  labName           String   // Diagnostic centre name
  licenseNumber     String   @unique
  address           String
  city              String
  state             String
  pincode           String
  isActive          Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([city])
}

model PhlebotomistProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  employeeId     String   @unique
  assignedRegion String   // City or area for assignments
  isAvailable    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assignedRegion])
}

model PharmacyProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  pharmacyName    String
  licenseNumber   String   @unique  // Drug license number
  gstNumber       String?
  address         String
  city            String
  state           String
  pincode         String
  isActive        Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([city])
}

// ============================================
// AUTHENTICATION
// ============================================

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================
// QUESTIONNAIRES
// ============================================

model QuestionnaireTemplate {
  id        String         @id @default(cuid())
  vertical  HealthVertical
  version   Int            @default(1)
  isActive  Boolean        @default(true)
  schema    Json           // JSON schema for the questionnaire
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  intakeResponses IntakeResponse[]

  @@unique([vertical, version])
  @@index([vertical, isActive])
}

model IntakeResponse {
  id                      String   @id @default(cuid())
  patientProfileId        String
  questionnaireTemplateId String
  responses               Json     // Patient's answers
  isDraft                 Boolean  @default(true)
  submittedAt             DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  patientProfile        PatientProfile        @relation(fields: [patientProfileId], references: [id], onDelete: Cascade)
  questionnaireTemplate QuestionnaireTemplate @relation(fields: [questionnaireTemplateId], references: [id])
  consultation          Consultation?

  @@index([patientProfileId])
  @@index([questionnaireTemplateId])
}

model PatientPhoto {
  id               String  @id @default(cuid())
  patientProfileId String
  type             String  // e.g., "scalp_top", "scalp_front", "face"
  url              String
  thumbnailUrl     String?

  createdAt DateTime @default(now())

  patientProfile PatientProfile @relation(fields: [patientProfileId], references: [id], onDelete: Cascade)

  @@index([patientProfileId])
}

// ============================================
// CONSULTATIONS & AI
// ============================================

model Consultation {
  id               String             @id @default(cuid())
  patientId        String
  doctorId         String?
  intakeResponseId String             @unique
  vertical         HealthVertical
  status           ConsultationStatus @default(PENDING_ASSESSMENT)
  doctorNotes      String?
  rejectionReason  String?
  scheduledAt      DateTime?
  completedAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  patient        User            @relation("PatientConsultations", fields: [patientId], references: [id])
  doctor         User?           @relation("DoctorConsultations", fields: [doctorId], references: [id])
  intakeResponse IntakeResponse  @relation(fields: [intakeResponseId], references: [id])
  aiAssessment   AIPreAssessment?
  prescription   Prescription?
  messages       Message[]
  followUps      FollowUp[]
  labOrders      LabOrder[]

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([vertical])
}

model AIPreAssessment {
  id              String   @id @default(cuid())
  consultationId  String   @unique
  summary         String   // AI-generated summary for doctor
  riskLevel       String   // LOW, MEDIUM, HIGH
  recommendedPlan String?
  flags           String[] // Important flags for doctor attention
  rawResponse     Json     // Full AI response for auditing
  modelVersion    String   // e.g., "claude-3-sonnet-20240229"
  createdAt       DateTime @default(now())

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  @@index([consultationId])
}

model FollowUp {
  id             String   @id @default(cuid())
  consultationId String
  scheduledAt    DateTime
  type           String   // "WEEK_2", "MONTH_1", "MONTH_3"
  isCompleted    Boolean  @default(false)
  completedAt    DateTime?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  @@index([consultationId])
  @@index([scheduledAt])
}

// ============================================
// PRESCRIPTIONS
// ============================================

model Prescription {
  id              String   @id @default(cuid())
  consultationId  String   @unique
  pdfUrl          String?  // S3 URL for generated PDF
  medications     Json     // Array of medication details
  instructions    String?
  validUntil      DateTime
  issuedAt        DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Spec: master spec Section 5.4 — Regulatory fields
  doctorName           String?   // Auto-populated from doctor profile
  doctorRegistrationNo String?   // NMC registration number
  patientName          String?   // Patient's full name
  patientPhone         String?   // Patient's phone number

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@index([consultationId])
}

// ============================================
// ORDERS & SHIPPING
// ============================================

// Spec: master spec Section 8.4 — Delivery Data Model
model Order {
  id              String      @id @default(cuid())
  patientId       String
  prescriptionId  String
  consultationId  String
  status          OrderStatus @default(PRESCRIPTION_CREATED)

  // Pharmacy details
  pharmacyPartnerId   String?
  pharmacyPartnerName String?
  pharmacyAddress     String?

  // Delivery person details
  deliveryPersonName  String?
  deliveryPersonPhone String?
  deliveryMethod      String?   // RAPIDO, DUNZO, OWN, PORTER, OTHER
  deliveryAddress     String
  deliveryCity        String
  deliveryPincode     String
  estimatedDeliveryTime String?
  deliveryOtp         String?   // 4-digit OTP for delivery confirmation

  // Financials (in paise)
  medicationCost      Int
  deliveryCost        Int       @default(0)
  totalAmount         Int

  // Reorder tracking
  parentOrderId       String?   // If this is a reorder
  isReorder           Boolean   @default(false)
  needsReview         Boolean   @default(false)  // True if prescription changed since last order

  // Timestamps (ALL per spec)
  orderedAt           DateTime  @default(now())
  sentToPharmacyAt    DateTime?
  pharmacyPreparingAt DateTime?
  pharmacyReadyAt     DateTime?
  pharmacyIssueAt     DateTime?
  pharmacyIssueReason String?
  pickupArrangedAt    DateTime?
  outForDeliveryAt    DateTime?
  deliveredAt         DateTime?
  deliveryFailedAt    DateTime?
  deliveryFailedReason String?
  rescheduledAt       DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?

  // Rating
  deliveryRating      Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient      User          @relation(fields: [patientId], references: [id])
  prescription Prescription  @relation(fields: [prescriptionId], references: [id])
  payment      Payment?

  @@index([patientId])
  @@index([prescriptionId])
  @@index([status])
  @@index([pharmacyPartnerId])
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS
// ============================================

model SubscriptionPlan {
  id              String         @id @default(cuid())
  vertical        HealthVertical
  name            String
  description     String?
  priceInPaise    Int            // Monthly price
  durationMonths  Int            @default(1)
  features        String[]
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  subscriptions Subscription[]

  @@index([vertical])
  @@index([isActive])
}

model Subscription {
  id                    String             @id @default(cuid())
  userId                String
  planId                String
  status                SubscriptionStatus @default(ACTIVE)
  razorpaySubscriptionId String?           @unique
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelledAt           DateTime?
  activeUntil           DateTime?          // When cancelled, active until this date

  // Failed payment handling (Spec: 3-day grace, retries day 1, 3, 7)
  failedPaymentCount    Int                @default(0)
  gracePeriodEndAt      DateTime?
  nextRetryAt           DateTime?

  // Pause/Resume
  pausedAt              DateTime?
  resumedAt             DateTime?

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user     User             @relation(fields: [userId], references: [id])
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]

  @@index([userId])
  @@index([planId])
  @@index([status])
}

model Payment {
  id                 String        @id @default(cuid())
  userId             String
  orderId            String?       @unique
  subscriptionId     String?
  amountPaise        Int
  status             PaymentStatus @default(PENDING)
  razorpayPaymentId  String?       @unique
  razorpayOrderId    String?       @unique
  razorpaySignature  String?
  method             String?       // "upi", "card", "netbanking", "wallet"
  failureReason      String?
  metadata           Json?         // { purpose, vertical, intakeResponseId, planId, etc. }
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  order        Order?        @relation(fields: [orderId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@index([subscriptionId])
  @@index([status])
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id             String   @id @default(cuid())
  consultationId String
  senderId       String
  content        String
  isFromAI       Boolean  @default(false)
  readAt         DateTime?
  createdAt      DateTime @default(now())

  // Spec: master spec Section 5.5 — Attachments (photos, PDFs)
  attachmentUrl  String?   // S3 URL for attachment
  attachmentType String?   // "image", "pdf", "document"

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([consultationId])
  @@index([senderId])
}

// ============================================
// BLOOD WORK & DIAGNOSTICS
// Spec: master spec Section 7
// ============================================

// Spec: master spec Section 7.5 — PartnerDiagnosticCentre
model PartnerDiagnosticCentre {
  id                  String   @id @default(cuid())
  name                String
  address             String
  city                String
  state               String
  pincode             String
  lat                 Float?
  lng                 Float?
  phone               String
  email               String?
  contactPerson       String?
  portalLoginPhone    String?  @unique // For portal OTP auth
  testsOffered        String[]
  testPricing         Json?    // { "TSH": 30000, "CBC": 25000 } in paise
  panelPricing        Json?    // { "Hair Loss Basic": 99900 } in paise
  avgTurnaroundHours  Int      @default(48)
  rating              Float?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  labOrders LabOrder[]

  @@index([city])
  @@index([isActive])
}

// Spec: master spec Section 7.5 — Phlebotomist
model Phlebotomist {
  id                    String   @id @default(cuid())
  name                  String
  phone                 String   @unique
  email                 String?
  certification         String?
  certificationDocUrl   String?
  availableDays         String[] // ["MONDAY", "TUESDAY", etc.]
  availableTimeStart    String?  // "08:00"
  availableTimeEnd      String?  // "18:00"
  maxDailyCollections   Int      @default(10)
  currentCity           String
  serviceableAreas      String[] // Pincodes
  completedCollections  Int      @default(0)
  failedCollections     Int      @default(0)
  rating                Float?
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  labOrders LabOrder[]
  labSlots  LabSlot[]

  @@index([currentCity])
  @@index([isActive])
}

// Spec: master spec Section 7.5 — PartnerPharmacy
model PartnerPharmacy {
  id                  String   @id @default(cuid())
  name                String
  address             String
  city                String
  state               String
  pincode             String
  lat                 Float?
  lng                 Float?
  phone               String
  email               String?
  contactPerson       String?
  portalLoginPhone    String?  @unique // For portal OTP auth
  drugLicenseNumber   String   @unique
  gstNumber           String?
  serviceableAreas    String[] // Pincodes covered
  avgPreparationMinutes Int    @default(30)
  rating              Float?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([city])
  @@index([isActive])
}

// Spec: master spec Section 7.5 — LabSlot
model LabSlot {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  startTime       String   // "08:00"
  endTime         String   // "10:00"
  phlebotomistId  String?
  maxBookings     Int      @default(5)
  currentBookings Int      @default(0)
  city            String
  serviceableAreas String[] // Pincodes covered by this slot
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  phlebotomist Phlebotomist? @relation(fields: [phlebotomistId], references: [id])

  @@index([date, city])
  @@index([phlebotomistId])
}

// Spec: master spec Section 7.5 — LabOrder (full timestamps per spec)
model LabOrder {
  id                String         @id @default(cuid())
  patientId         String
  consultationId    String
  doctorId          String
  testPanel         String[]       // ["TSH", "CBC", "Ferritin", "Vitamin_D"]
  panelName         String?        // "Hair Loss Basic Panel"
  doctorNotes       String?

  // Collection details
  bookedDate        DateTime?      @db.Date
  bookedTimeSlot    String?        // "8:00-10:00"
  collectionAddress String
  collectionCity    String
  collectionPincode String

  // Assignments
  phlebotomistId      String?
  diagnosticCentreId  String?

  // Status
  status LabOrderStatus @default(ORDERED)

  // ALL timestamps per spec Section 7.5
  orderedAt               DateTime  @default(now())
  slotBookedAt            DateTime?
  phlebotomistAssignedAt  DateTime?
  sampleCollectedAt       DateTime?
  collectionFailedAt      DateTime?
  collectionFailedReason  String?
  deliveredToLabAt        DateTime?
  sampleReceivedAt        DateTime?
  receivedTubeCount       Int?
  sampleIssueAt           DateTime?
  sampleIssueReason       String?
  processingStartedAt     DateTime?
  resultsUploadedAt       DateTime?
  doctorReviewedAt        DateTime?
  doctorReviewNotes       String?
  closedAt                DateTime?
  cancelledAt             DateTime?
  cancellationReason      String?
  expiredAt               DateTime?

  // Running late tracking (phlebotomist)
  estimatedArrivalTime String?   // New ETA when running late
  runningLateAt        DateTime?

  // Sample tracking
  tubeCount Int?
  tubeCountMismatch Boolean @default(false)

  // Results
  resultFileUrl           String?   // S3 URL for result PDF
  abnormalFlags           Json?     // { "TSH": "HIGH", "CBC": "NORMAL" }
  criticalValues          Boolean   @default(false)
  patientUploadedResults  Boolean   @default(false)
  patientUploadedFileUrl  String?

  // Recollection tracking
  parentLabOrderId    String?       // If this is a recollection order
  isFreeRecollection  Boolean       @default(false)

  // SLA tracking (Spec: Section 7.4)
  slaEscalatedAt       DateTime?
  slaEscalationReason  String?
  slaEscalatedBy       String?
  lastReminderSentAt   DateTime?
  lastReminderType     String?

  // Financials (in paise)
  labCost               Int
  patientCharge         Int         @default(0)
  coveredBySubscription Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patient          User                     @relation("PatientLabOrders", fields: [patientId], references: [id])
  consultation     Consultation             @relation(fields: [consultationId], references: [id])
  phlebotomist     Phlebotomist?            @relation(fields: [phlebotomistId], references: [id])
  diagnosticCentre PartnerDiagnosticCentre? @relation(fields: [diagnosticCentreId], references: [id])

  @@index([patientId])
  @@index([consultationId])
  @@index([status])
  @@index([orderedAt])
  @@index([bookedDate])
}

// ============================================
// AUDIT LOGGING (HIPAA/DPDPA Compliance)
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // "VIEW_PHI", "CREATE_PRESCRIPTION", etc.
  resource   String   // "Consultation", "Prescription", etc.
  resourceId String
  details    Json?    // Additional context
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
}
