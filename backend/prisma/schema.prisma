// Onlyou Database Schema
// Indian Telehealth Platform for Stigmatized Health Conditions

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// 7 roles per spec: patient, doctor, admin, lab, phlebotomist, pharmacy, delivery
enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
  LAB           // Diagnostic centre staff
  PHLEBOTOMIST  // Sample collectors
  PHARMACY      // Pharmacy partners
  DELIVERY      // Delivery personnel
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum HealthVertical {
  HAIR_LOSS
  SEXUAL_HEALTH
  PCOS
  WEIGHT_MANAGEMENT
}

enum ConsultationStatus {
  PENDING_ASSESSMENT
  AI_REVIEWED
  DOCTOR_REVIEWING
  VIDEO_SCHEDULED      // Phase 13: video slot booked, awaiting call
  VIDEO_COMPLETED      // Phase 13: video call done, doctor can prescribe
  AWAITING_LABS        // Phase 13: doctor wants labs before prescribing
  APPROVED
  NEEDS_INFO
  REJECTED
}

// Spec: master spec Section 8.3 — Order Status Enum
enum OrderStatus {
  PRESCRIPTION_CREATED
  SENT_TO_PHARMACY
  PHARMACY_PREPARING
  PHARMACY_READY
  PHARMACY_ISSUE
  PICKUP_ARRANGED
  OUT_FOR_DELIVERY
  DELIVERED
  DELIVERY_FAILED
  RESCHEDULED
  RETURNED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

// Spec: Phase 13 — Video Session Status
enum VideoSessionStatus {
  SCHEDULED
  WAITING_FOR_PATIENT
  WAITING_FOR_DOCTOR
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW_PATIENT
  NO_SHOW_DOCTOR
  FAILED
}

// Spec: Phase 13 — Call Type (TPG 2020: all 3 are valid consultation types)
enum CallType {
  VIDEO
  AUDIO_ONLY
  PHONE_FALLBACK
}

// Spec: Phase 13 — Day of Week for recurring availability
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// Spec: Phase 13 — Booked Slot Status
enum BookedSlotStatus {
  BOOKED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// Spec: Phase 15 — Pharmacy Status
enum PharmacyStatus {
  PENDING_VERIFICATION
  DOCUMENTS_SUBMITTED
  UNDER_REVIEW
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

// Spec: Phase 15 — Pharmacy Staff Role
enum PharmacyStaffRole {
  PHARMACIST
  DISPENSER
  DELIVERY_COORDINATOR
  PHARMACY_ADMIN
}

// Spec: master spec Section 7.3 — Lab Order Status Enum
// Main flow: ORDERED → SLOT_BOOKED → PHLEBOTOMIST_ASSIGNED → SAMPLE_COLLECTED →
//            DELIVERED_TO_LAB → SAMPLE_RECEIVED → PROCESSING → RESULTS_READY →
//            DOCTOR_REVIEWED → CLOSED
// Branches: COLLECTION_FAILED, SAMPLE_ISSUE, RESULTS_UPLOADED, CANCELLED, EXPIRED
enum LabOrderStatus {
  ORDERED
  SLOT_BOOKED
  PHLEBOTOMIST_ASSIGNED
  SAMPLE_COLLECTED
  COLLECTION_FAILED
  DELIVERED_TO_LAB
  SAMPLE_RECEIVED
  SAMPLE_ISSUE
  PROCESSING
  RESULTS_READY
  RESULTS_UPLOADED      // Patient self-upload path
  DOCTOR_REVIEWED
  CLOSED
  CANCELLED
  EXPIRED
}

// ============================================
// USER & PROFILES
// ============================================

model User {
  id            String    @id @default(cuid())
  phone         String    @unique // +91XXXXXXXXXX format
  email         String?   @unique
  name          String?
  role          UserRole  @default(PATIENT)
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  patientProfile      PatientProfile?
  doctorProfile       DoctorProfile?
  staffProfile        StaffProfile?
  labProfile          LabProfile?
  phlebotomistProfile PhlebotomistProfile?
  pharmacyProfile     PharmacyProfile?
  refreshTokens       RefreshToken[]
  consultations   Consultation[]    @relation("PatientConsultations")
  doctorReviews   Consultation[]    @relation("DoctorConsultations")
  orders          Order[]
  subscriptions   Subscription[]
  payments        Payment[]
  messages        Message[]
  auditLogs       AuditLog[]
  labOrders       LabOrder[]        @relation("PatientLabOrders")
  wallet          Wallet?

  // Phase 13: Video consultation relations
  doctorVideoSessions   VideoSession[]          @relation("DoctorVideoSessions")
  patientVideoSessions  VideoSession[]          @relation("PatientVideoSessions")
  doctorAvailability    DoctorAvailabilitySlot[] @relation("DoctorAvailabilitySlots")
  doctorBookedSlots     BookedSlot[]            @relation("DoctorBookedSlots")
  patientBookedSlots    BookedSlot[]            @relation("PatientBookedSlots")

  // Phase 15: Pharmacy relations
  pharmacyStaffs        PharmacyStaff[]
  onboardedPharmacies   Pharmacy[]              @relation("PharmacyOnboardedBy")
  activatedPharmacies   Pharmacy[]              @relation("PharmacyActivatedBy")
  suspendedPharmacies   Pharmacy[]              @relation("PharmacySuspendedBy")

  @@index([phone])
  @@index([role])
}

model PatientProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  fullName    String?
  dateOfBirth DateTime?
  gender      Gender?
  height      Float?    // in cm
  weight      Float?    // in kg

  // Address (Indian format)
  addressLine1  String?
  addressLine2  String?
  city          String?
  state         String?
  pincode       String?   // 6-digit Indian postal code

  // Onboarding fields
  healthGoals           String[]  @default([])  // Selected health verticals
  onboardingComplete    Boolean   @default(false)
  telehealthConsent     Boolean   @default(false)
  telehealthConsentDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  intakeResponses IntakeResponse[]
  photos          PatientPhoto[]
  healthProfiles  HealthProfile[]

  @@index([userId])
}

// Onboarding health snapshot per condition
// Stores quick Q&A before full intake consultation
model HealthProfile {
  id               String   @id @default(cuid())
  patientProfileId String
  condition        String   // "HAIR_LOSS", "SEXUAL_HEALTH", "WEIGHT_MANAGEMENT", "PCOS"
  responses        Json     // Stores all Q&A for that condition

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientProfile PatientProfile @relation(fields: [patientProfileId], references: [id], onDelete: Cascade)

  @@unique([patientProfileId, condition])
  @@index([patientProfileId])
}

model DoctorProfile {
  id                String           @id @default(cuid())
  userId            String           @unique
  registrationNo    String           @unique // Medical Council Registration (NMC)
  specialization    String           // Legacy singular field — use specializations[] for new code
  specializations   String[]         // e.g., ["Urology", "Andrology"]
  verticals         HealthVertical[] // which condition verticals this doctor handles
  qualifications    String[]
  yearsOfExperience Int
  bio               String?
  avatarUrl         String?
  signatureUrl      String?          // Digital signature for prescriptions
  isAvailable       Boolean          @default(true)
  isActive          Boolean          @default(true) // Soft delete flag
  seniorDoctor      Boolean          @default(false) // Receives high-attention cases
  dailyCaseLimit    Int              @default(15) // Max consultations per day (1-50)
  consultationFee   Int              @default(0) // in paise
  lastAssignedAt    DateTime?        // For round-robin tie-breaking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([specialization])
}

model StaffProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  department String
  employeeId String  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Spec: master spec Section 13 — Partner profiles
model LabProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  labName           String   // Diagnostic centre name
  licenseNumber     String   @unique
  address           String
  city              String
  state             String
  pincode           String
  isActive          Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([city])
}

model PhlebotomistProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  employeeId     String   @unique
  assignedRegion String   // City or area for assignments
  isAvailable    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assignedRegion])
}

model PharmacyProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  pharmacyName    String
  licenseNumber   String   @unique  // Drug license number
  gstNumber       String?
  address         String
  city            String
  state           String
  pincode         String
  isActive        Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([city])
}

// ============================================
// AUTHENTICATION
// ============================================

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================
// QUESTIONNAIRES
// ============================================

model QuestionnaireTemplate {
  id        String         @id @default(cuid())
  vertical  HealthVertical
  version   Int            @default(1)
  isActive  Boolean        @default(true)
  schema    Json           // JSON schema for the questionnaire
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  intakeResponses IntakeResponse[]

  @@unique([vertical, version])
  @@index([vertical, isActive])
}

model IntakeResponse {
  id                      String   @id @default(cuid())
  patientProfileId        String
  questionnaireTemplateId String
  responses               Json     // Patient's answers
  isDraft                 Boolean  @default(true)
  submittedAt             DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  patientProfile        PatientProfile        @relation(fields: [patientProfileId], references: [id], onDelete: Cascade)
  questionnaireTemplate QuestionnaireTemplate @relation(fields: [questionnaireTemplateId], references: [id])
  consultation          Consultation?

  @@index([patientProfileId])
  @@index([questionnaireTemplateId])
}

model PatientPhoto {
  id               String  @id @default(cuid())
  patientProfileId String
  type             String  // e.g., "scalp_top", "scalp_front", "face"
  url              String
  thumbnailUrl     String?

  createdAt DateTime @default(now())

  patientProfile PatientProfile @relation(fields: [patientProfileId], references: [id], onDelete: Cascade)

  @@index([patientProfileId])
}

// ============================================
// CONSULTATIONS & AI
// ============================================

model Consultation {
  id                String             @id @default(cuid())
  patientId         String
  doctorId          String?
  intakeResponseId  String             @unique
  vertical          HealthVertical
  status            ConsultationStatus @default(PENDING_ASSESSMENT)
  doctorNotes       String?
  rejectionReason   String?
  scheduledAt       DateTime?
  completedAt       DateTime?
  assignedAt        DateTime?          // When doctor was auto-assigned
  slaDeadline       DateTime?          // When SLA expires for current doctor
  previousDoctorIds String[]           @default([]) // Track re-assignment chain (max 3)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  patient        User            @relation("PatientConsultations", fields: [patientId], references: [id])
  doctor         User?           @relation("DoctorConsultations", fields: [doctorId], references: [id])
  intakeResponse IntakeResponse  @relation(fields: [intakeResponseId], references: [id])
  aiAssessment   AIPreAssessment?
  prescription   Prescription?
  messages       Message[]
  followUps      FollowUp[]
  labOrders      LabOrder[]

  // Phase 13: Video consultation relations
  videoSessions  VideoSession[]
  bookedSlots    BookedSlot[]

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([vertical])
}

model AIPreAssessment {
  id              String   @id @default(cuid())
  consultationId  String   @unique
  summary         String   // AI-generated summary for doctor
  riskLevel       String   // LOW, MEDIUM, HIGH
  recommendedPlan String?
  flags           String[] // Important flags for doctor attention
  rawResponse     Json     // Full AI response for auditing
  modelVersion    String   // e.g., "claude-3-sonnet-20240229"
  createdAt       DateTime @default(now())

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  @@index([consultationId])
}

model FollowUp {
  id             String   @id @default(cuid())
  consultationId String
  scheduledAt    DateTime
  type           String   // "WEEK_2", "MONTH_1", "MONTH_3"
  isCompleted    Boolean  @default(false)
  completedAt    DateTime?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  @@index([consultationId])
  @@index([scheduledAt])
}

// ============================================
// PRESCRIPTIONS
// ============================================

model Prescription {
  id              String   @id @default(cuid())
  consultationId  String   @unique
  pdfUrl          String?  // S3 URL for generated PDF
  medications     Json     // Array of medication details
  instructions    String?
  validUntil      DateTime
  issuedAt        DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Spec: master spec Section 5.4 — Regulatory fields
  doctorName           String?   // Auto-populated from doctor profile
  doctorRegistrationNo String?   // NMC registration number
  patientName          String?   // Patient's full name
  patientPhone         String?   // Patient's phone number

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@index([consultationId])
}

// ============================================
// ORDERS & SHIPPING
// ============================================

// Spec: master spec Section 8.4 — Delivery Data Model
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique  // Format: ORD-XXXXXX
  patientId       String
  prescriptionId  String
  consultationId  String
  status          OrderStatus @default(PRESCRIPTION_CREATED)
  items           Json        @default("[]")  // Array of medication items [{name, dosage, quantity}]

  // Pharmacy details
  pharmacyPartnerId   String?
  pharmacyPartnerName String?
  pharmacyAddress     String?

  // Delivery person details
  deliveryPersonName  String?
  deliveryPersonPhone String?
  deliveryMethod      String?   // RAPIDO, DUNZO, OWN, PORTER, OTHER
  deliveryAddress     String
  deliveryCity        String
  deliveryPincode     String
  estimatedDeliveryTime String?
  deliveryOtp         String?   // 4-digit OTP for delivery confirmation

  // Financials (in paise)
  medicationCost      Int
  deliveryCost        Int       @default(0)
  totalAmount         Int

  // Reorder tracking
  parentOrderId       String?   // If this is a reorder
  isReorder           Boolean   @default(false)
  needsReview         Boolean   @default(false)  // True if prescription changed since last order

  // Timestamps (ALL per spec)
  orderedAt           DateTime  @default(now())
  sentToPharmacyAt    DateTime?
  pharmacyPreparingAt DateTime?
  pharmacyReadyAt     DateTime?
  pharmacyIssueAt     DateTime?
  pharmacyIssueReason String?
  pickupArrangedAt    DateTime?
  outForDeliveryAt    DateTime?
  deliveredAt         DateTime?
  deliveryFailedAt    DateTime?
  deliveryFailedReason String?
  rescheduledAt       DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?

  // Rating
  deliveryRating      Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient      User          @relation(fields: [patientId], references: [id])
  prescription Prescription  @relation(fields: [prescriptionId], references: [id])
  payment      Payment?

  @@index([patientId])
  @@index([prescriptionId])
  @@index([status])
  @@index([pharmacyPartnerId])
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS
// ============================================

model SubscriptionPlan {
  id              String         @id @default(cuid())
  vertical        HealthVertical
  name            String
  description     String?
  priceInPaise    Int            // Monthly price
  durationMonths  Int            @default(1)
  features        String[]
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  subscriptions Subscription[]

  @@unique([vertical, durationMonths])
  @@index([vertical])
  @@index([isActive])
}

model Subscription {
  id                    String             @id @default(cuid())
  userId                String
  planId                String
  status                SubscriptionStatus @default(ACTIVE)
  razorpaySubscriptionId String?           @unique
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelledAt           DateTime?
  activeUntil           DateTime?          // When cancelled, active until this date

  // Failed payment handling (Spec: 3-day grace, retries day 1, 3, 7)
  failedPaymentCount    Int                @default(0)
  gracePeriodEndAt      DateTime?
  nextRetryAt           DateTime?

  // Pause/Resume
  pausedAt              DateTime?
  resumedAt             DateTime?

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user     User             @relation(fields: [userId], references: [id])
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]

  @@index([userId])
  @@index([planId])
  @@index([status])
}

model Payment {
  id                 String        @id @default(cuid())
  userId             String
  orderId            String?       @unique
  subscriptionId     String?
  amountPaise        Int
  status             PaymentStatus @default(PENDING)
  razorpayPaymentId  String?       @unique
  razorpayOrderId    String?       @unique
  razorpaySignature  String?
  method             String?       // "upi", "card", "netbanking", "wallet"
  failureReason      String?
  metadata           Json?         // { purpose, vertical, intakeResponseId, planId, etc. }
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  order        Order?        @relation(fields: [orderId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@index([subscriptionId])
  @@index([status])
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id             String   @id @default(cuid())
  consultationId String
  senderId       String
  content        String
  isFromAI       Boolean  @default(false)
  readAt         DateTime?
  createdAt      DateTime @default(now())

  // Spec: master spec Section 5.5 — Attachments (photos, PDFs)
  attachmentUrl  String?   // S3 URL for attachment
  attachmentType String?   // "image", "pdf", "document"

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([consultationId])
  @@index([senderId])
}

// ============================================
// BLOOD WORK & DIAGNOSTICS
// Spec: master spec Section 7
// ============================================

// Spec: master spec Section 7.5 — PartnerDiagnosticCentre
model PartnerDiagnosticCentre {
  id                  String   @id @default(cuid())
  name                String
  address             String
  city                String
  state               String
  pincode             String
  lat                 Float?
  lng                 Float?
  phone               String
  email               String?
  contactPerson       String?
  portalLoginPhone    String?  @unique // For portal OTP auth
  testsOffered        String[]
  testPricing         Json?    // { "TSH": 30000, "CBC": 25000 } in paise
  panelPricing        Json?    // { "Hair Loss Basic": 99900 } in paise
  avgTurnaroundHours  Int      @default(48)
  rating              Float?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  labOrders LabOrder[]

  @@index([city])
  @@index([isActive])
}

// Spec: master spec Section 7.5 — Phlebotomist
model Phlebotomist {
  id                    String   @id @default(cuid())
  name                  String
  phone                 String   @unique
  email                 String?
  certification         String?
  certificationDocUrl   String?
  availableDays         String[] // ["MONDAY", "TUESDAY", etc.]
  availableTimeStart    String?  // "08:00"
  availableTimeEnd      String?  // "18:00"
  maxDailyCollections   Int      @default(10)
  currentCity           String
  serviceableAreas      String[] // Pincodes
  completedCollections  Int      @default(0)
  failedCollections     Int      @default(0)
  rating                Float?
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  labOrders LabOrder[]
  labSlots  LabSlot[]

  @@index([currentCity])
  @@index([isActive])
}

// Spec: master spec Section 7.5 — PartnerPharmacy
model PartnerPharmacy {
  id                  String   @id @default(cuid())
  name                String
  address             String
  city                String
  state               String
  pincode             String
  lat                 Float?
  lng                 Float?
  phone               String
  email               String?
  contactPerson       String?
  portalLoginPhone    String?  @unique // For portal OTP auth
  drugLicenseNumber   String   @unique
  gstNumber           String?
  serviceableAreas    String[] // Pincodes covered
  avgPreparationMinutes Int    @default(30)
  rating              Float?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([city])
  @@index([isActive])
}

// Spec: master spec Section 7.5 — LabSlot
model LabSlot {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  startTime       String   // "08:00"
  endTime         String   // "10:00"
  phlebotomistId  String?
  maxBookings     Int      @default(5)
  currentBookings Int      @default(0)
  city            String
  serviceableAreas String[] // Pincodes covered by this slot
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  phlebotomist Phlebotomist? @relation(fields: [phlebotomistId], references: [id])

  @@index([date, city])
  @@index([phlebotomistId])
}

// Spec: master spec Section 7.5 — LabOrder (full timestamps per spec)
model LabOrder {
  id                String         @id @default(cuid())
  patientId         String
  consultationId    String
  doctorId          String
  testPanel         String[]       // ["TSH", "CBC", "Ferritin", "Vitamin_D"]
  panelName         String?        // "Hair Loss Basic Panel"
  doctorNotes       String?

  // Collection details
  bookedDate        DateTime?      @db.Date
  bookedTimeSlot    String?        // "8:00-10:00"
  collectionAddress String
  collectionCity    String
  collectionPincode String

  // Assignments
  phlebotomistId      String?
  diagnosticCentreId  String?

  // Status
  status LabOrderStatus @default(ORDERED)

  // ALL timestamps per spec Section 7.5
  orderedAt               DateTime  @default(now())
  slotBookedAt            DateTime?
  phlebotomistAssignedAt  DateTime?
  sampleCollectedAt       DateTime?
  collectionFailedAt      DateTime?
  collectionFailedReason  String?
  deliveredToLabAt        DateTime?
  sampleReceivedAt        DateTime?
  receivedTubeCount       Int?
  sampleIssueAt           DateTime?
  sampleIssueReason       String?
  processingStartedAt     DateTime?
  resultsUploadedAt       DateTime?
  doctorReviewedAt        DateTime?
  doctorReviewNotes       String?
  closedAt                DateTime?
  cancelledAt             DateTime?
  cancellationReason      String?
  expiredAt               DateTime?

  // Running late tracking (phlebotomist)
  estimatedArrivalTime String?   // New ETA when running late
  runningLateAt        DateTime?

  // Sample tracking
  tubeCount Int?
  tubeCountMismatch Boolean @default(false)

  // Results
  resultFileUrl           String?   // S3 URL for result PDF
  abnormalFlags           Json?     // { "TSH": "HIGH", "CBC": "NORMAL" }
  criticalValues          Boolean   @default(false)
  patientUploadedResults  Boolean   @default(false)
  patientUploadedFileUrl  String?

  // Recollection tracking
  parentLabOrderId    String?       // If this is a recollection order
  isFreeRecollection  Boolean       @default(false)

  // SLA tracking (Spec: Section 7.4)
  slaEscalatedAt       DateTime?
  slaEscalationReason  String?
  slaEscalatedBy       String?
  lastReminderSentAt   DateTime?
  lastReminderType     String?

  // Financials (in paise)
  labCost               Int
  patientCharge         Int         @default(0)
  coveredBySubscription Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patient          User                     @relation("PatientLabOrders", fields: [patientId], references: [id])
  consultation     Consultation             @relation(fields: [consultationId], references: [id])
  phlebotomist     Phlebotomist?            @relation(fields: [phlebotomistId], references: [id])
  diagnosticCentre PartnerDiagnosticCentre? @relation(fields: [diagnosticCentreId], references: [id])

  @@index([patientId])
  @@index([consultationId])
  @@index([status])
  @@index([orderedAt])
  @@index([bookedDate])
}

// ============================================
// NOTIFICATIONS
// Spec: master spec Section 11 (Notification System)
// ============================================

// Notification channels per spec
enum NotificationChannel {
  PUSH         // Firebase FCM
  WHATSAPP     // MSG91
  SMS          // MSG91
  EMAIL        // Email service
  IN_APP       // In-app notification bell
}

// Notification status
enum NotificationStatus {
  PENDING      // Created, not yet sent
  SENT         // Sent to provider (FCM, MSG91, etc.)
  DELIVERED    // Confirmed delivered
  READ         // User read/opened
  FAILED       // Failed to send
}

// Notification event types per spec Section 11
enum NotificationEventType {
  // Blood work events (Spec: Section 11 - Blood Work Notifications)
  LAB_TESTS_ORDERED
  LAB_SLOT_BOOKED
  LAB_PHLEBOTOMIST_ASSIGNED
  LAB_COLLECTION_REMINDER       // 30 min before
  LAB_RUNNING_LATE
  LAB_SAMPLE_COLLECTED
  LAB_COLLECTION_FAILED
  LAB_SAMPLE_RECEIVED
  LAB_SAMPLE_ISSUE
  LAB_RESULTS_READY
  LAB_CRITICAL_VALUES
  LAB_DOCTOR_REVIEWED
  LAB_BOOKING_REMINDER_3DAY
  LAB_BOOKING_REMINDER_14DAY
  LAB_OVERDUE_48HR
  LAB_OVERDUE_72HR

  // Delivery events (Spec: Section 11 - Delivery Notifications)
  DELIVERY_PRESCRIPTION_CREATED
  DELIVERY_PHARMACY_PREPARING
  DELIVERY_PHARMACY_READY
  DELIVERY_PHARMACY_ISSUE
  DELIVERY_OUT_FOR_DELIVERY
  DELIVERY_DELIVERED
  DELIVERY_FAILED
  DELIVERY_MONTHLY_REORDER

  // Subscription events
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_RENEWAL_REMINDER
  SUBSCRIPTION_PAYMENT_FAILED
  SUBSCRIPTION_EXPIRED

  // General
  WELCOME
  CONSULTATION_ASSIGNED
  MESSAGE_RECEIVED
}

model Notification {
  id              String              @id @default(cuid())
  recipientId     String              // User ID
  recipientRole   UserRole            // Which role (for filtering)
  channel         NotificationChannel
  eventType       NotificationEventType
  title           String
  body            String
  data            Json?               // Additional data (labOrderId, orderId, etc.)
  status          NotificationStatus  @default(PENDING)

  // Discreet mode applied
  isDiscreet      Boolean             @default(false)

  // Reference to source entity
  labOrderId      String?
  orderId         String?
  consultationId  String?
  subscriptionId  String?

  // Timestamps
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  failedAt        DateTime?
  failureReason   String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([recipientId])
  @@index([recipientRole])
  @@index([status])
  @@index([eventType])
  @@index([createdAt])
}

// Spec: master spec Section 11 — Patient Notification Preferences
model NotificationPreference {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Channel toggles (default: all ON)
  pushEnabled     Boolean  @default(true)
  whatsappEnabled Boolean  @default(true)
  smsEnabled      Boolean  @default(true)
  emailEnabled    Boolean  @default(true)

  // Sensitive mode: generic text instead of condition-specific
  // "Onlyou: You have an update" instead of detailed text
  discreetMode    Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================
// AUDIT LOGGING (HIPAA/DPDPA Compliance)
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // "VIEW_PHI", "CREATE_PRESCRIPTION", etc.
  resource   String   // "Consultation", "Prescription", etc.
  resourceId String
  details    Json?    // Additional context
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
}

// ============================================
// WALLET & REFUNDS
// Spec: master spec Section 10 (Refund & Wallet)
// ============================================

// Credit types: refund, promo, comeback
enum WalletCreditType {
  REFUND     // Never expires
  PROMO      // Expires after 90 days
  COMEBACK   // For returning customers
}

// Refund triggers per spec Section 10
enum RefundTrigger {
  DOCTOR_NOT_SUITABLE      // Full refund - doctor says not suitable
  PATIENT_DECLINES_REFERRAL // Full refund - patient-initiated
  CANCEL_BEFORE_REVIEW     // Full refund - cancel <24hrs before review
  CANCEL_AFTER_REVIEW      // 50% partial refund
  TECHNICAL_ERROR          // Full refund - auto via webhook
  DELIVERY_ISSUE           // Full replacement or refund - support-initiated
}

// Patient choice for refund
enum RefundMethod {
  WALLET               // Instant credit to wallet
  ORIGINAL_PAYMENT     // 5-7 days back to original payment method
}

model Wallet {
  id           String   @id @default(cuid())
  userId       String   @unique
  balancePaise Int      @default(0) // Always in paise, never rupees

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([userId])
}

model WalletTransaction {
  id           String           @id @default(cuid())
  walletId     String
  type         String           // "CREDIT" or "DEBIT"
  creditType   WalletCreditType? // Only for credits
  amountPaise  Int
  balanceAfter Int              // Balance after this transaction

  // Reference data
  description  String?
  referenceId  String?          // Payment ID, Order ID, etc.
  referenceType String?         // "PAYMENT", "ORDER", "REFUND"

  // For refund credits
  refundTrigger RefundTrigger?
  refundMethod  RefundMethod?

  // For promo credits expiry
  expiresAt    DateTime?

  createdAt DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
}

// Refund tracking model
model Refund {
  id             String        @id @default(cuid())
  userId         String
  paymentId      String?       // Original payment
  orderId        String?       // Related order
  consultationId String?       // Related consultation

  trigger        RefundTrigger
  method         RefundMethod
  amountPaise    Int
  status         String        @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED

  // Razorpay refund details (if refund to original method)
  razorpayRefundId String?
  processedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([paymentId])
  @@index([status])
}

// ============================================
// VIDEO CONSULTATIONS (Phase 13)
// Spec: Phase 13 — TPG 2020 compliance for Schedule H prescriptions
// ============================================

model VideoSession {
  id                   String             @id @default(cuid())
  consultationId       String
  doctorId             String
  patientId            String
  roomId               String?            // 100ms room ID, null until room created
  status               VideoSessionStatus @default(SCHEDULED)
  scheduledStartTime   DateTime
  scheduledEndTime     DateTime
  actualStartTime      DateTime?          // When both parties joined
  actualEndTime        DateTime?          // When session ended
  durationSeconds      Int?               // Calculated from actual times
  recordingConsentGiven Boolean           @default(false)
  recordingUrl         String?            // R2/S3 URL, encrypted at rest
  callType             CallType           @default(VIDEO)
  disconnectCount      Int                @default(0)
  reconnectRoomId      String?            // New room after disconnect
  notes                String?            // Doctor's post-call notes
  noShowMarkedBy       String?            // Who marked the no-show
  cancellationReason   String?
  cancelledBy          String?
  cancelledAt          DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  consultation Consultation @relation(fields: [consultationId], references: [id])
  doctor       User         @relation("DoctorVideoSessions", fields: [doctorId], references: [id])
  patient      User         @relation("PatientVideoSessions", fields: [patientId], references: [id])
  bookedSlots  BookedSlot[]

  @@index([consultationId])
  @@index([doctorId])
  @@index([patientId])
  @@index([status])
  @@index([scheduledStartTime])
}

model DoctorAvailabilitySlot {
  id                  String    @id @default(cuid())
  doctorId            String
  dayOfWeek           DayOfWeek
  startTime           String    // "18:00" (IST, 24hr format)
  endTime             String    // "20:00"
  slotDurationMinutes Int       @default(15)
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  doctor      User         @relation("DoctorAvailabilitySlots", fields: [doctorId], references: [id])
  bookedSlots BookedSlot[]

  @@unique([doctorId, dayOfWeek, startTime])
  @@index([doctorId])
  @@index([dayOfWeek])
}

model BookedSlot {
  id                 String          @id @default(cuid())
  videoSessionId     String
  availabilitySlotId String?
  doctorId           String
  patientId          String
  consultationId     String
  slotDate           DateTime        @db.Date
  startTime          DateTime
  endTime            DateTime
  status             BookedSlotStatus @default(BOOKED)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  videoSession     VideoSession          @relation(fields: [videoSessionId], references: [id])
  availabilitySlot DoctorAvailabilitySlot? @relation(fields: [availabilitySlotId], references: [id])
  doctor           User                  @relation("DoctorBookedSlots", fields: [doctorId], references: [id])
  patient          User                  @relation("PatientBookedSlots", fields: [patientId], references: [id])
  consultation     Consultation          @relation(fields: [consultationId], references: [id])

  @@unique([doctorId, slotDate, startTime])
  @@index([doctorId, slotDate])
  @@index([patientId])
  @@index([consultationId])
  @@index([status])
}

// ============================================
// PHARMACY MANAGEMENT (Phase 15)
// Spec: Phase 15 — Pharmacy Auto-Assignment + Fulfillment
// ============================================

model Pharmacy {
  id                          String         @id @default(cuid())
  name                        String
  city                        String
  address                     String
  pincode                     String
  contactPhone                String
  contactEmail                String?
  status                      PharmacyStatus @default(PENDING_VERIFICATION)

  // Cold chain
  hasColdChainCapability      Boolean        @default(false)
  coldChainVerified           Boolean        @default(false)
  coldChainVerifiedAt         DateTime?
  coldChainVerifiedBy         String?

  // Services & capacity
  servicesAvailable           String[]       // e.g., ["standard", "cold-chain", "schedule-h1"]
  dailyOrderLimit             Int            @default(50)
  operatingHoursStart         String?        // "09:00" IST
  operatingHoursEnd           String?        // "21:00" IST
  currentQueueSize            Int            @default(0)

  // Licensing
  drugLicenseNumber           String         @unique
  drugLicenseExpiry           DateTime?
  gstNumber                   String?
  pharmacyRegistrationNumber  String?

  // Owner details
  ownerName                   String
  ownerPhone                  String
  ownerEmail                  String?

  // Onboarding documents
  agreementSignedAt           DateTime?
  agreementDocumentUrl        String?
  drugLicenseDocumentUrl      String?
  gstDocumentUrl              String?

  // Admin tracking
  onboardedById               String?
  activatedById               String?
  activatedAt                 DateTime?
  suspensionReason            String?
  suspendedById               String?
  suspendedAt                 DateTime?
  deactivationReason          String?
  notes                       String?

  createdAt                   DateTime       @default(now())
  updatedAt                   DateTime       @updatedAt

  // Relations
  onboardedBy                 User?          @relation("PharmacyOnboardedBy", fields: [onboardedById], references: [id])
  activatedBy                 User?          @relation("PharmacyActivatedBy", fields: [activatedById], references: [id])
  suspendedBy                 User?          @relation("PharmacySuspendedBy", fields: [suspendedById], references: [id])
  staff                       PharmacyStaff[]

  @@index([city])
  @@index([status])
  @@index([pincode])
}

model PharmacyStaff {
  id                                String            @id @default(cuid())
  pharmacyId                        String
  userId                            String            @unique
  name                              String
  email                             String?
  phone                             String
  role                              PharmacyStaffRole @default(DISPENSER)

  // Pharmacist-specific credentials
  pharmacistRegistrationNumber      String?
  pharmacistRegistrationExpiry      DateTime?
  pharmacistRegistrationDocumentUrl String?

  // Permissions
  isActive                          Boolean           @default(true)
  canAcceptOrders                   Boolean           @default(false)
  canDispense                       Boolean           @default(false)
  canManageInventory                Boolean           @default(false)

  // Tracking
  lastLoginAt                       DateTime?
  invitedById                       String?
  invitedAt                         DateTime          @default(now())
  activatedAt                       DateTime?

  createdAt                         DateTime          @default(now())
  updatedAt                         DateTime          @updatedAt

  // Relations
  pharmacy                          Pharmacy          @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  user                              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pharmacyId])
  @@index([userId])
}
